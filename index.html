<!DOCTYPE html>
<html>
  <head>
    <!-- CDNによるphaserの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser.min.js"></script>
  </head>
  <body>
    <script>
      //ゲームに関する設定
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: "arcade",
          arcade: {
            gravity: {},
            debug: false,
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };
      var player;
      var customers;
      var prev_x;
      var prev_y;
      var money = 1000;
      var gameOver = false;

      function preload() {
        this.load.image("back", "assets/bg_kusa.JPG");
        this.load.image("building", "assets/building.png");
        this.load.image("yen", "assets/yen.png");
        this.load.image("customer", "assets/customer_s.png");
        this.load.spritesheet("bike", "assets/bike_deliver_sprite.png", {
          frameWidth: 293,
          frameHeight: 288,
        });
      }

      function create() {
        this.add.image(400, 300, "back").setScale(2.0);
        buildings = this.physics.add.staticGroup();
        for (var i = 1; i < 30; i++) {
          buildings.create(
            40 + 135 * (i % 6),
            60 + 135 * Math.floor(i / 6),
            "building"
          );
        }

        prev_x = 50;
        prev_y = 50;
        player = this.physics.add.sprite(prev_x, prev_y, "bike").setScale(0.17);
        this.anims.create({
          key: "left",
          frames: this.anims.generateFrameNumbers("bike", { start: 0, end: 1 }),
          frameRate: 10,
          repeat: -1,
        });

        this.anims.create({
          key: "right",
          frames: this.anims.generateFrameNumbers("bike", { start: 2, end: 3 }),
          frameRate: 10,
          repeat: -1,
        });
        this.anims.create({
          key: "stop",
          frames: [{ key: "bike", frame: 0 }],
          frameRate: 20,
        });
        player.anims.play("left", true);

        //  Collide the player and the stars with the platforms
        this.physics.add.collider(player, buildings);

        //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
        customers = this.physics.add.group({
          key: "customer",
          repeat: 4,
          setXY: { x: 230, y: 130, stepX: 135 },
        });
        this.physics.add.overlap(player, customers, deliverBudget, null, this);

        this.add.image(25, 25, "yen").setScale(0.5);
        moneyText = this.add.text(46, 8, money, {
          fontSize: "32px",
          fill: "#000",
        });
      }

      function update() {
        if (gameOver) {
          return;
        }

        if (this.input.activePointer.isDown) {
          player.setVelocityX((this.input.activePointer.x - player.x) * 2);
          player.setVelocityY((this.input.activePointer.y - player.y) * 2);
          if (player.body.velocity.x > 0) {
            player.anims.play("left", true);
          } else {
            player.anims.play("right", true);
          }
        } else {
          player.setVelocityX(0);
          player.setVelocityY(0);
        }

        cost = Math.floor(
          Math.pow(prev_x - player.x, 2) + Math.pow(prev_y - player.y, 2)
        );
        prev_x = player.x;
        prev_y = player.y;
        money -= cost;
        moneyText.setText(money);
        if (money < 0) {
          moneyText.setText(0);
          this.physics.pause();
          player.setTint(0xff0000);
          player.anims.play("stop");
          gameOver = true;
        }
      }

      function deliverBudget(player, customer) {
        customer.disableBody(true, true);
        money += 500;
        moneyText.setText(money);
      }
      var game = new Phaser.Game(config);
    </script>
  </body>
</html>
